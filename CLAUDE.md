# WorldGenTest 開発ガイドライン

このドキュメントは、WorldGenTestプロジェクトの開発に関するガイドライン、注意事項、今後の計画をまとめたものです。

## プロジェクト概要

WorldGenTestは、Architecturyフレームワークを使用したMinecraft Modの開発学習プロジェクトです。将来的な大規模Mod開発を想定し、様々な技術やパターンを検証することを目的としています。

## 技術選択の理由

### Architectury選択理由
- **マルチプラットフォーム対応**: Forge、NeoForge、Fabricに対応可能
- **コード共有**: プラットフォーム間でのコード重複を最小化
- **メンテナンス性**: 一つのコードベースで複数のプラットフォームをサポート
- **コミュニティサポート**: 活発な開発とアップデート

### ModDevGradle 2.0採用理由
- **シンプルな設定**: NeoGradleより簡潔なビルドスクリプト
- **安定性**: 2025年1月に安定版リリース
- **パフォーマンス**: より高速なビルド処理

## 開発方針

### コード品質
1. **可読性重視**: 分かりやすい変数名、クラス名を使用
2. **モジュール化**: 機能ごとに適切にクラスを分離
3. **ドキュメント**: 複雑な処理にはコメントを追加
4. **テスト**: 可能な限りテストコードを作成

### 機能実装
1. **段階的実装**: 小さな機能から始めて徐々に拡張
2. **バージョン管理**: 機能追加時は適切にコミット
3. **互換性**: 既存機能を壊さないよう注意
4. **パフォーマンス**: 重い処理は最適化を検討

## 実装済み機能

### ✅ 完了済み

#### プロジェクト基盤
- Architecturyマルチプラットフォーム設定
- Gradle設定（ModDevGradle 2.0）
- 基本的なModエントリーポイント
- クリエイティブタブ設定

#### カスタムブロック
- クリスタルブロック（発光ブロック）
- ブロックモデル、アイテムモデル
- 多言語対応（英語・日本語）

#### カスタムアイテム
- クリスタルの欠片（Crystal Shard）
- クリスタルツール5種類（剣、ピッケル、斧、シャベル、クワ）
- カスタムツール材料（ModToolTiers）
- プラットフォーム固有実装（Fabric: ToolMaterial、NeoForge: Tier）
- レシピシステム統合

#### カスタムバイオーム
- Crystalline Caves（クリスタルの洞窟）
- バイオーム設定（温度、湿度、色彩）
- Mob生成設定
- 地形生成設定（洞窟、鉱石）

#### カスタムエンティティ
- [x] Crystal Golem（クリスタルゴーレム）- Fabric/NeoForge両対応
- エンティティ属性、AI行動の実装
- カスタムモデル・レンダリング・テクスチャ
- プラットフォーム固有の登録システム

#### レシピシステム
- クリスタルブロック crafting recipe（Minecraft 1.21.1対応）
- クリスタルツール5種類のcrafting recipe（Minecraft 1.21.1対応）
- アドバンスメントシステム統合
- レシピブック対応
- カテゴリ別アドバンスメント（decorations、equipment）

## 今後の機能拡張計画

### 🔄 短期計画（1-2週間）

#### レシピシステム
- [x] クリスタルブロックのクラフトレシピ（Minecraft 1.21.1対応完了）
- [ ] 精錬レシピ
- [ ] カスタムレシピタイプ

#### アイテム追加
- [x] クリスタルの欠片（アイテム）- 2025年9月実装完了
- [x] クリスタルツール（剣、ピッケル、斧、シャベル、クワ）- 2025年9月実装完了
- [ ] クリスタル防具

#### ワールド生成強化
- [ ] クリスタル鉱石
- [ ] 洞窟装飾（鍾乳石など）
- [ ] カスタム構造物

### 🎯 中期計画（1-2ヶ月）

#### エンティティ
- [x] クリスタルゴーレム（友好Mob）- 完了
- [ ] クリスタルスパイダー（敵対Mob）
- [x] カスタムエンティティレンダリング - 完了

#### 高度なワールド生成
- [ ] マルチバイオーム構造
- [ ] 地下都市生成
- [ ] ディメンション追加

#### GUI・ユーザーインターフェース
- [ ] クリスタル加工台（カスタムGUI）
- [ ] エナジーシステム
- [ ] 進捗システム

### 🚀 長期計画（3ヶ月以上）

#### 魔法システム
- [ ] クリスタルベースの魔法
- [ ] 呪文システム
- [ ] マナシステム

#### ネットワーク機能
- [ ] サーバー間通信
- [ ] プレイヤーデータ同期
- [ ] マルチプレイヤー対応強化

#### MOD連携
- [ ] JEI連携
- [ ] Curios API連携
- [ ] Applied Energistics連携

## 開発時の注意事項

### Minecraft 1.21.1での重要な変更点（2025年9月確認）
1. **リソースディレクトリ構造変更**:
   - `advancements` → `advancement` (単数形)
   - `recipes` → `recipe` (単数形)
   - この変更により従来の複数形ディレクトリは認識されない
2. **レシピフォーマット変更**:
   - 旧: `"G": {"item": "minecraft:glass"}`
   - 新: `"G": "minecraft:glass"` (簡潔な文字列形式)
3. **アドバンスメントフォーマット変更**:
   - 旧: `"items": ["minecraft:diamond"]` (配列)
   - 新: `"items": "minecraft:diamond"` (文字列)
4. **レシピカテゴリとアドバンスメントディレクトリは別概念**:
   - レシピのcategoryフィールド: `misc`, `building_blocks`, `decorations`等
   - アドバンスメントディレクトリ: `recipe/decorations/`, `recipe/food/`等
5. **Modレシピには必ずアドバンスメントを追加**:
   - Minecraftの自動発見システムはバニラレシピ（`minecraft:` namespace）に最適化
   - カスタムnamespace（例：`worldgentest:`）のレシピは自動発見されない
   - レシピブック表示のため、Modレシピには対応するアドバンスメントファイルが必須
   - アドバンスメントなしのModレシピは材料入手時にレシピブックに表示されない

### Architecturyでの開発
1. **共通コード**: できるだけcommonモジュールに実装
2. **プラットフォーム固有**: 必要最小限に留める
3. **@ExpectPlatform**: プラットフォーム固有の処理で使用
4. **registries**: Architecturyの登録システムを活用
5. **リソース管理の重要原則**:
   - **commonのリソースは自動共有**: `common/src/main/resources/`内のassetsとdataは、ビルド時に自動的にfabricとneoforgeにコピーされる
   - **プラットフォーム固有リソースのみ個別配置**: プラットフォーム間で異なる必要がある場合のみ、`fabric/src/main/resources/`や`neoforge/src/main/resources/`に配置
   - **重複リソースの回避**: 同じリソースをcommonとプラットフォーム固有の両方に置くと競合が発生する可能性がある
   - **ベストプラクティス**:
     - テクスチャ、モデル、言語ファイルなど共通リソースは`common/src/main/resources/`に配置
     - プラットフォーム固有の設定ファイル（mod.jsonなど）のみプラットフォーム側に配置
     - リソース変更が必要な場合のみプラットフォーム側にオーバーライド用ファイルを配置

### バージョン管理
1. **依存関係**: 定期的にバージョンアップデート
2. **Minecraft**: 新バージョンへの対応計画
3. **互換性**: 下位バージョンとの互換性検討

### パフォーマンス
1. **クライアント負荷**: レンダリング処理の最適化
2. **サーバー負荷**: ワールド生成の効率化
3. **メモリ使用量**: 不要なオブジェクト生成を避ける

### セキュリティ
1. **入力検証**: ユーザー入力は必ず検証
2. **権限管理**: 管理者機能の適切な制限
3. **データ保護**: プレイヤーデータの安全な処理

## 学習ポイント

このプロジェクトで学習・検証する技術領域：

### Minecraft Modding
- バイオーム生成とカスタマイズ
- ブロック・アイテムの実装パターン
- エンティティ作成とAI
- ワールド生成アルゴリズム

### Architectury Framework
- マルチプラットフォーム開発
- 共通コードとプラットフォーム固有コードの分離
- レジストリシステムの活用
- リソース管理

### ソフトウェア設計
- モジュラーアーキテクチャ
- プラグインシステム
- 設定管理
- テスト駆動開発

## リソース・参考資料

### 公式ドキュメント
- [Architectury Documentation](https://docs.architectury.dev/)
- [NeoForge Documentation](https://docs.neoforged.net/)
- [Minecraft Wiki](https://minecraft.wiki/)

### コミュニティ
- [Architectury Discord](https://discord.gg/architectury)
- [ModdingByKaupenjoe](https://courses.kaupenjoe.net/)
- [r/feedthebeast](https://reddit.com/r/feedthebeast)

### 開発ツール
- IntelliJ IDEA（推奨IDE）
- MCreator（ビジュアル開発）
- Blockbench（モデル作成）

## コミット・リリース方針

### コミットメッセージ
Conventional Commitsに従う：
- `feat:` 新機能追加
- `fix:` バグ修正
- `docs:` ドキュメント更新
- `refactor:` リファクタリング
- `test:` テスト追加・修正

### バージョニング
Semantic Versioningに従う：
- MAJOR: 非互換性のある変更
- MINOR: 後方互換性のある機能追加
- PATCH: 後方互換性のあるバグ修正

### リリースノート
各リリースで以下を記載：
- 新機能
- バグ修正
- 破壊的変更
- 既知の問題

## 開発時のトラブルシューティング・学習事項

### エンティティ登録でのmapping問題（2025年9月）

#### 問題
- Minecraft 1.21.1 + Architectury + Fabric環境でエンティティ登録時にClassNotFoundError発生
- 具体的エラー：`java.lang.ClassNotFoundException: net.minecraft.class_2378`
- `net.minecraft.class_1429`（ResourceLocation関連）のmapping問題も発生

#### 原因と対策
1. **開発環境mappingの不整合**
   - 開発時とランタイムでのmapping差異が原因
   - commonモジュールでのエンティティ登録がplatform-specificなクラスにアクセスしようとしている

2. **Platform-specificコードの分離不足**
   - エンティティ登録はプラットフォーム固有処理として扱う必要がある
   - `FabricModEntities.java`として分離したが、まだmapping問題が残存

3. **ResourceLocation使用方法の変更**
   - 旧: `new ResourceLocation(MOD_ID, "name")`
   - 新: `ResourceLocation.parse(MOD_ID + ":name")`
   - コンストラクタがprivateアクセスになった影響

#### 一時的対応
- エンティティ登録を完全にコメントアウトして基本機能（ブロック・バイオーム）の動作確認を優先
- 基本機能が正常動作することを確認してからエンティティ機能の再実装を検討

#### 今後の対応方針
1. **より詳細なmapping調査**
   - 開発環境とランタイム環境でのmapping差異を詳しく調査
   - 正しいmapped nameの使用を確認

2. **代替アプローチの検討**
   - Architecturyの `@ExpectPlatform` パターンの使用
   - より確実なプラットフォーム分離方法の採用

3. **段階的実装**
   - まず基本機能（ブロック・バイオーム・レシピ）を完全に動作させる
   - その後、安定した方法でエンティティ機能を追加

#### 学習ポイント
- Minecraft ModのEntity実装は最も複雑な部分の一つ
- Architecturyでのmulti-platform開発では、platform-specificな処理の適切な分離が重要
- 開発環境特有の問題と実際のバグを区別して対応することが重要

### エンティティ実装の成功パターン（2025年9月解決）

#### 解決した実装アプローチ
1. **プラットフォーム完全分離方式の採用**
   - commonモジュールでエンティティクラス、モデル、レンダラーを実装
   - 各プラットフォーム（fabric/neoforge）で独立したエンティティ登録システムを構築
   - プラットフォーム固有の属性登録とクライアントレンダリング登録を実装

2. **NeoForge固有の実装要件**
   - `EntityAttributeCreationEvent`でのエンティティ属性登録が必須
   - `EntityRenderersEvent.RegisterLayerDefinitions`でのモデルレイヤー登録が必要
   - `EntityRenderersEvent.RegisterRenderers`でのレンダラー登録
   - 適切なEventBusSubscriber設定とクライアント専用アノテーション（@Dist.CLIENT）

3. **リソース統合の実践**
   - エンティティテクスチャをcommon/resources/assetsに統合
   - 重複ファイルの削除によるビルドエラー回避
   - Architecturyの自動リソース共有機能の活用

#### 成功要因
- プラットフォーム固有の登録システムを理解し、それぞれに適した実装方法を採用
- Architecturyの自動リソース共有を活用してコード重複を最小化
- 段階的なテストとエラー解析による問題の特定と解決

### クリスタルツール実装の成功パターン（2025年9月完了）

#### 実装アプローチ
1. **プラットフォーム別ツール実装**
   - **Fabric**: カスタムToolMaterialクラスでgetInverseTag()メソッド実装
   - **NeoForge**: 共通ModToolTiers（Tierインターフェース）で標準コンストラクタ使用
   - **共通**: ModToolTiersクラスでツール性能統一管理

2. **テクスチャ作成手法**
   - Minecraftの既存ダイヤモンドツールテクスチャをベースに加工
   - Pythonを使った自動色調変換で効率的なテクスチャ生成
   - クリスタルの欠片・ブロックと統一された色調で識別性向上

3. **レシピシステム統合**
   - Minecraft 1.21.1の新フォーマット対応
   - カテゴリ別アドバンスメント（equipment）でレシピブック連携
   - プラットフォーム間共通リソースによる一元管理

#### 技術的学習ポイント
- **プラットフォーム差異**: FabricとNeoForgeでのツールコンストラクタ仕様の違い
- **リソース効率化**: Python PIL活用による既存アセット再利用手法
- **ユーザビリティ**: ダイヤモンドツールとの視覚的差別化の重要性
- **システム統合**: レシピ、アドバンスメント、クリエイティブタブの一括対応

#### 実装規模
- 5種類のツール（剣、ピッケル、斧、シャベル、クワ）
- 2プラットフォーム対応（Fabric、NeoForge）
- 5レシピ + 5アドバンスメント
- 多言語対応（英語・日本語）